<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOUR LOAN CALCULATOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #28A745;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
        }

        .loan-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        input[type="number"], select, .tenure-display {
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="number"]:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
            outline: none;
        }

        .selector-section {
            margin-bottom: 30px;
        }

        .selector-section h2 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        .selector-options {
            display: flex;
            gap: 15px;
            overflow-x: auto; 
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
        }
        .selector-options::-webkit-scrollbar {
            display: none; 
        }

        .selector-item {
            flex: 0 0 auto;
            padding: 15px 25px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
        }

        .selector-item:hover {
            transform: translateY(-3px);
            border-color: var(--primary-color);
        }

        .selector-item.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
        }

        .result-section {
            text-align: center;
            padding: 30px;
            background-color: #ffffff; 
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
        }

        .result-section h3 {
            color: var(--text-color);
            font-weight: 600;
            margin-bottom: 15px;
        }

        #emi-result {
            font-size: 3rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .emi-details {
            font-size: 1rem;
            color: #6c757d;
        }
        .emi-details p {
            margin: 5px 0;
        }

        /* --- AI Feature Styling (UPDATED) --- */
        .ai-feature {
            margin-top: 30px;
            padding: 20px;
            background-color: #e6f7ff; /* Light blue background for AI section */
            border-radius: var(--border-radius);
            border: 1px solid #91d5ff;
            color: var(--text-color);
        }
        .ai-feature h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
        .ai-feature p {
            font-size: 0.9rem;
        }
        #ai-response-display {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ced4da;
            white-space: pre-wrap; /* Keeps formatting and line breaks */
            min-height: 50px;
            text-align: left;
        }
        #ai-button {
            margin-top: 10px; 
            padding: 10px 15px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: background-color 0.3s;
        }
        #ai-button:hover {
            background-color: #0056b3;
        }
        #ai-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container">
    <h1><span style="color:#28A745;"></span>YOUR LOAN CALCULATOR</h1>

    <div class="selector-section">
        <h2>1. Choose Loan Type</h2>
        <div class="selector-options" id="loan-type-options">
            </div>
    </div>

    <div class="selector-section">
        <h2>2. Select Bank and Loan Details</h2>
        <div class="loan-inputs">
            <div class="input-group">
                <label for="bank-selector">Bank & Interest Rate (p.a.)</label>
                <select id="bank-selector" onchange="updateRateFromBank()">
                    </select>
            </div>

            <div class="input-group">
                <label for="custom-rate">Or Enter Custom Rate (%)</label>
                <input type="number" id="custom-rate" value="4.5" min="0.1" step="0.1" placeholder="e.g., 4.5" oninput="calculateEMI()">
            </div>
            
            <div class="input-group">
                <label for="loan-amount">Loan Amount (AED)</label>
                <input type="number" id="loan-amount" value="200000" min="1000" placeholder="e.g., 200,000" oninput="calculateEMI()">
            </div>
        </div>
    </div>

    <div class="selector-section">
        <h2>3. Choose Tenure (Months)</h2>
        <div class="selector-options" id="tenure-options">
            </div>
        <div class="input-group" style="margin-top: 15px;">
            <label for="tenure-input">Or Enter Custom Tenure (Months)</label>
            <input type="number" id="tenure-input" value="60" min="1" max="360" placeholder="e.g., 60" oninput="selectCustomTenure(this.value)">
        </div>
    </div>
    
    <div class="result-section">
        <h3>Your Estimated Monthly EMI</h3>
        <div id="emi-result">0.00 AED</div>
        <div class="emi-details">
            <p>Total Interest Payable: <span id="total-interest">0.00 AED</span></p>
            <p>Total Payment (Principal + Interest): <span id="total-payment">0.00 AED</span></p>
        </div>
    </div>

    <div class="ai-feature">
        <h4>✨ AI Loan Advisor - Running Locally</h4>
        <p>Ask for advice on UAE loans (Car, Housing, Personal, Health).</p>
        <textarea id="ai-prompt" style="width: 100%; height: 80px; margin-top: 10px; border-radius: 8px; padding: 10px;" placeholder="Type your loan question here..."></textarea>
        <button id="ai-button" onclick="askAIAdvisor()">Ask AI Advisor</button>
        <div id="ai-response-display">
            The AI Advisor response will appear here. **(Remember to run 'python ai_server.py' first!)**
        </div>
    </div>

</div>

<script>
    // ------------------ DATA ------------------

    // Placeholder data for Loan Types and Banks with typical UAE rates (annual percentage rate - APR)
    const LOAN_DATA = {
        'Car Loan': {
            banks: [
                { name: 'Emirates NBD', rate: 4.25 },
                { name: 'Mashreq', rate: 3.99 },
                { name: 'ADCB', rate: 4.50 },
                { name: 'DIB (Islamic)', rate: 3.75 },
                { name: 'Emirates Islamic', rate: 4.00 }
            ],
            defaultRate: 4.25
        },
        'Housing Loan': {
            banks: [
                { name: 'Emirates NBD', rate: 2.99 },
                { name: 'Mashreq', rate: 3.10 },
                { name: 'ADCB', rate: 3.25 },
                { name: 'ADIB (Islamic)', rate: 2.85 },
                { name: 'Standard Chartered', rate: 3.50 }
            ],
            defaultRate: 3.15
        },
        'Personal Loan': {
            banks: [
                { name: 'Emirates NBD', rate: 5.99 },
                { name: 'Mashreq', rate: 6.25 },
                { name: 'ADCB', rate: 6.50 },
                { name: 'HSBC', rate: 6.75 },
                { name: 'Emirates Islamic', rate: 6.00 }
            ],
            defaultRate: 6.25
        },
        'Health Loan': { 
            banks: [
                { name: 'Emirates NBD', rate: 7.00 },
                { name: 'Mashreq', rate: 7.25 },
                { name: 'ADCB', rate: 7.50 },
                { name: 'DIB (Islamic)', rate: 6.80 }
            ],
            defaultRate: 7.25
        }
    };

    // Tenure options in months (1 year, 2, 3, 4, 5, 7, 10, 15, 20, 25 years)
    const TENURE_OPTIONS = [12, 24, 36, 48, 60, 84, 120, 180, 240, 300];

    let selectedLoanType = 'Car Loan';
    let selectedTenure = 60; 

    // ------------------ CORE LOGIC ------------------

    /**
     * The core EMI calculation formula.
     * M = P [ i(1 + i)^n ] / [ (1 + i)^n – 1]
     * P = Principal Loan Amount
     * i = Monthly Interest Rate (Annual Rate / 1200)
     * n = Number of Monthly Payments (Tenure in Months)
     */
    function calculateEMI() {
        const principal = parseFloat(document.getElementById('loan-amount').value) || 0;
        const annualRate = parseFloat(document.getElementById('custom-rate').value) || 0;
        const tenureMonths = parseInt(document.getElementById('tenure-input').value) || 0;

        if (principal <= 0 || annualRate <= 0 || tenureMonths <= 0) {
            document.getElementById('emi-result').textContent = '0.00 AED';
            document.getElementById('total-interest').textContent = '0.00 AED';
            document.getElementById('total-payment').textContent = '0.00 AED';
            return;
        }

        // Monthly interest rate (i) in decimal form
        const monthlyRate = annualRate / (12 * 100); 
        
        // Compound factor
        const compoundFactor = Math.pow(1 + monthlyRate, tenureMonths);
        
        // EMI Calculation
        const emi = principal * monthlyRate * compoundFactor / (compoundFactor - 1);
        
        const totalPayment = emi * tenureMonths;
        const totalInterest = totalPayment - principal;

        // Display results
        document.getElementById('emi-result').textContent = formatCurrency(emi);
        document.getElementById('total-interest').textContent = formatCurrency(totalInterest);
        document.getElementById('total-payment').textContent = formatCurrency(totalPayment);
    }

    // Helper to format currency
    function formatCurrency(amount) {
        return amount.toLocaleString('en-US', {
            style: 'currency',
            currency: 'AED',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // ------------------ UI INTERACTIONS ------------------

    function renderLoanTypes() {
        const container = document.getElementById('loan-type-options');
        container.innerHTML = '';
        Object.keys(LOAN_DATA).forEach(type => {
            const item = document.createElement('div');
            item.classList.add('selector-item');
            if (type === selectedLoanType) {
                item.classList.add('selected');
            }
            item.textContent = type;
            item.onclick = () => selectLoanType(type);
            container.appendChild(item);
        });
    }

    function selectLoanType(type) {
        selectedLoanType = type;
        renderLoanTypes(); // Re-render to update selection style
        renderBankSelector(type); // Update bank options
        updateRateFromBank(); // Apply the new default rate
        // Recalculate EMI is called inside updateRateFromBank
    }

    function renderBankSelector(loanType) {
        const bankData = LOAN_DATA[loanType];
        const selector = document.getElementById('bank-selector');
        selector.innerHTML = ''; // Clear previous options

        // Add default "Custom Rate" option
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Custom Rate - Select or Enter Below';
        selector.appendChild(customOption);

        // Add bank options
        bankData.banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.rate;
            // Display the bank name and its rate
            option.textContent = `${bank.name} (${bank.rate.toFixed(2)}%)`;
            selector.appendChild(option);
        });

        // Set the default selection to the first bank
        selector.value = bankData.banks[0].rate;
    }

    function updateRateFromBank() {
        const selector = document.getElementById('bank-selector');
        const customRateInput = document.getElementById('custom-rate');
        
        const selectedValue = selector.value;
        
        if (selectedValue !== 'custom') {
            // If a bank is selected, update the custom rate input and recalculate
            customRateInput.value = parseFloat(selectedValue).toFixed(2);
        } else {
            // If custom is selected, do not overwrite the custom rate input, but ensure a default is there
            if (!customRateInput.value) {
                customRateInput.value = LOAN_DATA[selectedLoanType].defaultRate;
            }
        }
        
        calculateEMI();
    }

    function renderTenureOptions() {
        const container = document.getElementById('tenure-options');
        container.innerHTML = '';
        TENURE_OPTIONS.forEach(months => {
            const item = document.createElement('div');
            item.classList.add('selector-item');
            if (months === selectedTenure) {
                item.classList.add('selected');
            }
            const years = months / 12;
            item.textContent = months === 12 ? '1 Year' : `${years} Years (${months}M)`;
            item.onclick = () => selectTenure(months);
            container.appendChild(item);
        });
    }

    function selectTenure(months) {
        selectedTenure = months;
        document.getElementById('tenure-input').value = months; // Update the input box
        renderTenureOptions(); // Re-render to update selection style
        calculateEMI();
    }
    
    function selectCustomTenure(months) {
        selectedTenure = parseInt(months);
        // Deselect all carousel items when a custom value is entered
        const items = document.querySelectorAll('#tenure-options .selector-item');
        items.forEach(item => item.classList.remove('selected'));
        
        // If the custom input matches a pre-defined option, select it
        if(TENURE_OPTIONS.includes(selectedTenure)) {
            const index = TENURE_OPTIONS.indexOf(selectedTenure);
            items[index].classList.add('selected');
        }
        
        calculateEMI();
    }

    // ------------------ NEW AI INTEGRATION (IMPORTANT) ------------------

    // This is the URL for the local Python Flask server you must run
    const BACKEND_URL = 'http://127.0.0.1:5000'; 

    async function askAIAdvisor() {
        const promptInput = document.getElementById('ai-prompt');
        const responseDisplay = document.getElementById('ai-response-display');
        const button = document.getElementById('ai-button');
        
        const promptText = promptInput.value.trim();

        if (promptText.length < 5) {
            responseDisplay.textContent = "Please enter a question longer than 5 characters.";
            return;
        }

        // Disable button and show loading state
        button.disabled = true;
        button.textContent = 'Thinking...';
        responseDisplay.textContent = 'Contacting AI Advisor...';

        try {
            // Send the prompt to your local Python server (Flask)
            const response = await fetch(`${BACKEND_URL}/api/ai-advisor`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // Send the prompt as a JSON payload
                body: JSON.stringify({ prompt: promptText })
            });

            const data = await response.json();

            if (data.success) {
                // Display the AI response
                responseDisplay.textContent = data.response;
            } else {
                // Handle API error from your local server (e.g., failed to connect to OpenAI)
                responseDisplay.textContent = `Error: ${data.message || 'Could not get response from local server.'}`;
            }

        } catch (error) {
            // Handle network error (e.g., the Python server is not running)
            console.error('Fetch error:', error);
            responseDisplay.textContent = `Connection Error: Make sure your local Python server is running on ${BACKEND_URL}. Run 'python ai_server.py' in your terminal.`;
        } finally {
            // Re-enable button
            button.disabled = false;
            button.textContent = 'Ask AI Advisor';
        }
    }

    // ------------------ INITIALIZATION ------------------

    function initialize() {
        // Initial rendering
        renderLoanTypes();
        renderBankSelector(selectedLoanType);
        renderTenureOptions();
        
        // Initial setup for inputs
        document.getElementById('tenure-input').value = selectedTenure;
        document.getElementById('custom-rate').value = LOAN_DATA[selectedLoanType].defaultRate.toFixed(2);

        // Add event listeners to trigger calculation on input change
        document.getElementById('loan-amount').addEventListener('input', calculateEMI);
        document.getElementById('bank-selector').addEventListener('change', updateRateFromBank);
        document.getElementById('custom-rate').addEventListener('input', calculateEMI);
        document.getElementById('tenure-input').addEventListener('input', selectCustomTenure);
        
        // Perform initial calculation
        calculateEMI();
    }

    // Run the initialization function when the page loads
    window.onload = initialize;
</script>

</body>
</html>